<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Food Quality & Taste Checking Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF LIBS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {font-family: Arial, Helvetica, sans-serif;background:#f4f4f4;margin:0;padding:12px;color:#111}
.container {max-width:1100px;margin:auto}
.sheet {background:#fff;border:1px solid #000;padding:15px;border-radius:6px;}

/* HEADER */
.header {display:flex;align-items:center;border-bottom:1px solid #000;padding-bottom:12px;margin-bottom:15px;gap:12px}
.header img {width:120px;max-height:80px;object-fit:contain}
.header h1 {flex:1;text-align:center;margin:0;font-size:20px}

/* MOBILE: center title below logo */
@media (max-width:520px){
  .header{flex-direction:column;align-items:flex-start}
  .header img{align-self:flex-start}
  .header h1{width:100%;text-align:center;margin-top:6px}
}

.top-grid {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}
.top-grid .box {flex:1 1 180px}
label {font-size:13px;color:#555;margin-bottom:4px;display:block}
input[type="text"], input[type="date"], textarea, select {width:100%;padding:7px;font-size:14px;border:1px solid #aaa;border-radius:4px;box-sizing:border-box}
textarea{min-height:70px;resize:vertical}

.section {border:1px solid #000;margin-bottom:18px;padding:12px;border-radius:6px}
.section-title {font-size:18px;font-weight:bold;margin-bottom:6px}
.section-total {font-weight:bold;color:#0a6;margin-bottom:8px}
.table-wrap {overflow-x:auto}

table {width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px;min-width:900px}
th, td {border:1px solid #000;padding:6px;vertical-align:middle;word-break:break-word;text-align:center}

td input[type="text"], td input[type="number"] {width:100%;max-width:100%;padding:4px 5px;height:32px;font-size:13px;border:1px solid #aaa;border-radius:3px;box-sizing:border-box}

.btn {padding:8px 12px;border-radius:6px;font-weight:bold;color:#fff;border:0;cursor:pointer}
.add {background:#0b63c6}
.lock {background:#28a745}
.reset {background:#dc3545}
.pdf {background:#6f42c1}
.ghost {background:#fff;color:#0b63c6;border:1px solid #0b63c6}

.saved-box {margin-top:15px}
.saved-list {border:1px dashed #aaa;padding:8px;background:#fafcff;border-radius:6px;max-height:140px;overflow:auto;font-size:14px}

.input-inline{display:flex;gap:8px;align-items:center}
.checkbox-row{display:flex;flex-wrap:wrap;gap:10px}
.checkbox-row label{display:flex;gap:6px;align-items:center;font-size:14px}

.signature-row{display:flex;gap:12px;flex-wrap:wrap}
.signature-row .sig{flex:1}

.small-note{font-size:12px;color:#555;margin-top:6px}
</style>
</head>

<body>
<div class="container">
  <div class="sheet" id="sheet">

    <!-- HEADER -->
    <div class="header">
      <img src="logo.png" alt="logo" id="logoImg">
      <h1>Food Quality &amp; Taste Checking Report</h1>
    </div>

    <!-- TOP FIELDS -->
    <div class="top-grid">
      <div class="box"><label>Date</label><input id="date" type="date"></div>
      <div class="box"><label>Time</label><input id="time" type="text" placeholder="e.g. 10:30 AM"></div>
      <div class="box"><label>Building</label><input id="bld" type="text"></div>
      <div class="box"><label>Floor</label><input id="flr" type="text"></div>
      <div class="box"><label>Counter / Outlet</label><input id="ctr" type="text"></div>
      <div class="box"><label>Vendor Name</label><input id="vendor" type="text"></div>
      <div class="box"><label>Supervisor</label><input id="supervisor" type="text"></div>
      <div class="box"><label>Checked By</label><input id="checkedby" type="text"></div>
    </div>

    <!-- QUALITY TABLE SECTION -->
    <div class="section" id="quality-section">
      <div class="section-title">1. Food Quality Check</div>
      

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>S.No</th>
              <th style="width:250px">Item Name</th>
              <th>Temp (°C)</th>
              <th>Freshness</th>
              <th>Taste</th>
              <th>Texture</th>
              <th>Appearance</th>
              <th>Portion</th>
              <th>Remarks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="quality-body"></tbody>
        </table>
      </div>
      <button class="btn add" onclick="addRow()">+ Add Row</button>
    </div>

    <!-- HYGIENE CHECK -->
    <div class="section">
      <div class="section-title">2. Hygiene &amp; Handling Checklist</div>
      <div class="checkbox-row">
        <label><input type="checkbox" id="h_staff"> Staff Hygiene OK</label>
        <label><input type="checkbox" id="h_gloves"> Gloves / Cap / Apron</label>
        <label><input type="checkbox" id="h_covered"> Food Covered</label>
        <label><input type="checkbox" id="h_utensils"> Utensils Clean</label>
        <label><input type="checkbox" id="h_counter"> Counter Clean</label>
        <label><input type="checkbox" id="h_handwash"> Handwash / Sanitizer</label>
      </div>
      
    </div>

    <!-- TASTE / OBSERVATIONS -->
    <div class="section">
      <div class="section-title">3. Taste Validation Notes</div>
      <textarea id="tasteNotes" placeholder="Describe the taste: Balanced / Too spicy / Less salt / Other..."></textarea>
    </div>

    <div class="section">
      <div class="section-title">4. Special Observations</div>
      <textarea id="observations" placeholder="Any deviation, poor quality, customer complaints, time of issue, etc."></textarea>
    </div>

    <div class="section">
      <div class="section-title">5. Corrective Actions Taken</div>
      <textarea id="actions" placeholder="Immediate action taken to fix the issue."></textarea>
    </div>

    <!-- SIGNATURES -->
    <div class="section">
      <div class="section-title">Signatures</div>
      <div class="signature-row">
        <div class="sig"><label>Quality Checker</label><input id="sign_checker" type="text" placeholder="Name / Sign"></div>
        <div class="sig"><label>Vendor Supervisor</label><input id="sign_supervisor" type="text" placeholder="Name / Sign"></div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
      <input id="savename" placeholder="Save name" style="padding:8px;border:1px solid #aaa;border-radius:6px;">
      <button class="btn lock" id="saveAll">Save All</button>
      <button class="btn pdf" id="pdfBtn">Download PDF</button>
      <button class="btn reset" id="reset">Reset</button>
    </div>

    <!-- SAVED LIST -->
    <div class="saved-box" id="saved-box">
      <label>Saved Reports</label>
      <div class="saved-list" id="savedList">— none —</div>
    </div>

  </div>
</div>

<script>
/* -------------------------
   ROW HANDLING
------------------------- */
function addRow(data={}){
  const tbody=document.getElementById('quality-body');
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td class="idx"></td>
    <td><input class="item" type="text" value="${escapeHtml(data.item||'')}"></td>
    <td><input class="temp" type="number" step="0.1" value="${data.temp||''}"></td>
    <td><input class="fresh" type="text" value="${escapeHtml(data.fresh||'')}"></td>
    <td><input class="taste" type="text" value="${escapeHtml(data.taste||'')}"></td>
    <td><input class="texture" type="text" value="${escapeHtml(data.texture||'')}"></td>
    <td><input class="appear" type="text" value="${escapeHtml(data.appear||'')}"></td>
    <td><input class="portion" type="text" value="${escapeHtml(data.portion||'')}"></td>
    <td><input class="remarks" type="text" value="${escapeHtml(data.remarks||'')}"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove(); updateIndex();">Del</button></td>
  `;
  tbody.appendChild(tr);
  updateIndex();
  bindRow(tr);
}

function updateIndex(){
  [...document.querySelectorAll('#quality-body tr')].forEach((tr,i)=> tr.querySelector('.idx').textContent = i+1);
}

function bindRow(tr){
  tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', ()=>{}));
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* RESET */
document.getElementById('reset').onclick = ()=>{
  if(!confirm('Reset the form?')) return; location.reload();
};

/* -------------------------
   SAVE / LOAD
------------------------- */
document.getElementById('saveAll').onclick = function(){
  const name = document.getElementById('savename').value.trim();
  if(!name){ alert('Enter a name'); return; }
  const data = collectAll();
  localStorage.setItem('quality_'+name, JSON.stringify(data));
  loadSavedList();
  alert('Saved');
};

function collectAll(){
  return {
    meta: {
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      bld: document.getElementById('bld').value,
      flr: document.getElementById('flr').value,
      ctr: document.getElementById('ctr').value,
      vendor: document.getElementById('vendor').value,
      supervisor: document.getElementById('supervisor').value,
      checkedby: document.getElementById('checkedby').value,
      sign_checker: document.getElementById('sign_checker').value,
      sign_supervisor: document.getElementById('sign_supervisor').value
    },
    hygiene: {
      staff: document.getElementById('h_staff').checked,
      gloves: document.getElementById('h_gloves').checked,
      covered: document.getElementById('h_covered').checked,
      utensils: document.getElementById('h_utensils').checked,
      counter: document.getElementById('h_counter').checked,
      handwash: document.getElementById('h_handwash').checked
    },
    notes: {
      tasteNotes: document.getElementById('tasteNotes').value,
      observations: document.getElementById('observations').value,
      actions: document.getElementById('actions').value
    },
    items: [...document.querySelectorAll('#quality-body tr')].map(tr=>({
      item: tr.querySelector('.item').value,
      temp: tr.querySelector('.temp').value,
      fresh: tr.querySelector('.fresh').value,
      taste: tr.querySelector('.taste').value,
      texture: tr.querySelector('.texture').value,
      appear: tr.querySelector('.appear').value,
      portion: tr.querySelector('.portion').value,
      remarks: tr.querySelector('.remarks').value
    }))
  };
}

function loadSavedList(){
  const div=document.getElementById('savedList');
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('quality_'));
  if(!keys.length){ div.innerHTML='— none —'; return; }
  div.innerHTML='';
  keys.forEach(k=>{
    const name = k.replace('quality_','');
    const row = document.createElement('div');
    row.style = 'display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #ccc';
    row.innerHTML = `<b>${name}</b><div style="display:flex;gap:6px"><button class="btn ghost" onclick="loadSaved('${name}')">Load</button><button class="btn reset" onclick="deleteSaved('${name}')">Del</button></div>`;
    div.appendChild(row);
  });
}
loadSavedList();

function loadSaved(name){
  const d = JSON.parse(localStorage.getItem('quality_'+name));
  if(!d){ alert('Not found'); return; }
  const m = d.meta;
  document.getElementById('date').value = m.date || '';
  document.getElementById('time').value = m.time || '';
  document.getElementById('bld').value = m.bld || '';
  document.getElementById('flr').value = m.flr || '';
  document.getElementById('ctr').value = m.ctr || '';
  document.getElementById('vendor').value = m.vendor || '';
  document.getElementById('supervisor').value = m.supervisor || '';
  document.getElementById('checkedby').value = m.checkedby || '';
  document.getElementById('sign_checker').value = m.sign_checker || '';
  document.getElementById('sign_supervisor').value = m.sign_supervisor || '';

  const h = d.hygiene || {};
  document.getElementById('h_staff').checked = !!h.staff;
  document.getElementById('h_gloves').checked = !!h.gloves;
  document.getElementById('h_covered').checked = !!h.covered;
  document.getElementById('h_utensils').checked = !!h.utensils;
  document.getElementById('h_counter').checked = !!h.counter;
  document.getElementById('h_handwash').checked = !!h.handwash;

  document.getElementById('tasteNotes').value = (d.notes && d.notes.tasteNotes) || '';
  document.getElementById('observations').value = (d.notes && d.notes.observations) || '';
  document.getElementById('actions').value = (d.notes && d.notes.actions) || '';

  const tbody = document.getElementById('quality-body'); tbody.innerHTML = '';
  (d.items || []).forEach(it=> addRow(it));
  updateIndex();
  alert('Loaded');
}

function deleteSaved(name){
  if(!confirm('Delete saved report?')) return;
  localStorage.removeItem('quality_'+name);
  loadSavedList();
}

/* -------------------------
   PDF EXPORT
   - remove saved list
   - convert inputs to text
   - convert checkboxes to Yes/No
------------------------- */

document.getElementById('pdfBtn').onclick = async function(){
  const { jsPDF } = window.jspdf;
  const sheet = document.getElementById('sheet');
  const clone = sheet.cloneNode(true);

  // remove saved box from PDF
  const savedBox = clone.querySelector('#saved-box'); if(savedBox) savedBox.remove();

  // replace inputs & textareas
  clone.querySelectorAll('input,textarea,button,select').forEach(el=>{
    if(el.tagName === 'BUTTON') { el.remove(); return; }
    let text = '';
    if(el.type === 'checkbox') {
      const mark = el.checked ? '✔' : '✖';
      const color = el.checked ? 'green' : 'red';
      const div = document.createElement('div');
      div.textContent = mark;
      div.style.padding = '2px 4px';
      div.style.fontSize = '14px';
      div.style.fontWeight = 'bold';
      div.style.color = color;
      el.parentNode.replaceChild(div, el);
      return;
    }
    else text = el.value || el.textContent || '';

    const div = document.createElement('div');
    div.textContent = text;
    div.style.padding = '2px 4px';
    div.style.fontSize = '12px';
    // keep width behavior for table cells
    el.parentNode.replaceChild(div, el);
  });

  // ensure images loaded
  await Promise.all([...clone.querySelectorAll('img')].map(img=> new Promise(res=>{ if(img.complete) return res(); img.onload=img.onerror=res; })));

  // create container offscreen
  const container = document.createElement('div');
  container.style.position = 'fixed'; container.style.left='-9999px'; container.style.top='0'; container.style.width='1500px'; container.style.background='#fff';
  container.appendChild(clone);
  document.body.appendChild(container);

  const canvas = await html2canvas(clone, {scale:2.5, backgroundColor:'#fff', useCORS:true});
  const imgData = canvas.toDataURL('image/jpeg', 0.92);
  const pdf = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});
  const pageWidth = 297; const pageHeight = 210;
  const pxPerMm = canvas.width / pageWidth; const imgHeightMm = canvas.height / pxPerMm;

  if(imgHeightMm <= pageHeight){ pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeightMm); }
  else {
    let y = 0; const slicePx = pageHeight * pxPerMm;
    while(y < canvas.height){
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width = canvas.width;
      sliceCanvas.height = Math.min(slicePx, canvas.height - y);
      sliceCanvas.getContext('2d').drawImage(canvas, 0, y, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);
      const sliceImg = sliceCanvas.toDataURL('image/jpeg', 0.92);
      const sliceHeightMm = sliceCanvas.height / pxPerMm;
      if(y > 0) pdf.addPage('a4', 'landscape');
      pdf.addImage(sliceImg, 'JPEG', 0, 0, pageWidth, sliceHeightMm);
      y += slicePx;
    }
  }

  container.remove();
  pdf.save('FoodQualityReport.pdf');
};

// populate with a starter row
if(!document.querySelector('#quality-body tr')) addRow();

</script>

</body>
</html>
